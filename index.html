<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Foundry Battle Plan Manager — Map (Isometric)</title>

  <!-- Core styles -->
  <link rel="stylesheet" href="css/styles.css" />

  <!-- Mobile-specific overrides (load after main styles) -->
  <link rel="stylesheet" href="css/mobile.css" media="(max-width:900px)" />
</head>
<body>
  <h1 class="page-title">Foundry Battle Plan Manager — Map (Isometric)</h1>

  <!-- Modern controls placeholder (ui-controls.js will create content here).
       We also keep the legacy controls (hidden) so map.js can still find expected elements. -->
  <div id="modernControls" class="controls"></div>

  <!-- Legacy controls (kept for map.js compatibility, hidden visually) -->
  <div class="controls legacy-controls" style="display:none;">
    <label for="legionSelect">Legion:</label>
    <select id="legionSelect"></select>

    <div class="range-wrap">
      <label for="stageRange">Stage:</label>
      <input id="stageRange" type="range" min="1" max="1" value="1" />
      <span id="stageLabel">1</span>
    </div>

    <div class="refresh-wrap">
      <button id="refreshBtn">Reload data</button>
      <button id="toggleGridBtn">Toggle grid</button>
    </div>
  </div>

  <div class="map-wrapper" id="mapWrapper" aria-label="Isometric map">
    <!-- map container (absolute positioning inside) -->
    <div id="map" role="application"></div>

    <!-- decorative diamond play area -->
    <div class="map-playarea" aria-hidden="true"></div>

    <!-- coordinates panel (top center) - persistent until closed -->
    <div id="mapCoords" class="map-coords" aria-hidden="true">
      <div id="coordsContent"></div>
      <div class="coords-actions">
        <button id="copyCoordsBtn">Copy (gridX,gridY)</button>
        <button id="closeCoordsBtn">Close</button>
      </div>
    </div>

    <!-- tile highlight overlay (diamond) -->
    <div id="tileOverlay" class="tile-overlay" style="display:none"></div>

    <!-- click marker (temporary) -->
    <div id="mapClickMarker" class="map-click-marker" style="display:none"></div>

    <!-- Zoom controls (created for desktop & mobile) -->
    <div class="map-zoom-controls" aria-hidden="true">
      <button id="mapZoomIn" class="zoom-btn" aria-label="Zoom in">＋</button>
      <button id="mapZoomOut" class="zoom-btn" aria-label="Zoom out">－</button>
      <button id="mapZoomReset" class="zoom-btn" aria-label="Reset zoom">⤢</button>
    </div>

    <div class="map-zoom-help">Use pinch to zoom, drag to pan</div>
  </div>

  <div class="info-bar" id="infoBar"></div>

  <!-- Core map script must load first -->
  <script src="js/map.js"></script>

  <!-- Modern controls: creates the colorful stages bar, improved selector -->
  <script src="js/ui-controls.js"></script>

  <!-- Mobile-only helpers loader (loads only on small screens)
       - Loads map.mobile.js (mobile adapter) and mobile.js (UI helper) only when matchMedia matches.
       - Prevents any desktop impact; avoids double-loading by marking data-mobile-loader.
  -->
  <script>
    (function(){
      if (!(window.matchMedia && window.matchMedia('(max-width:900px)').matches)) return;
      // Prevent duplicate loaders
      if (document.querySelector('script[data-mobile-loader="1"]')) return;

      function loadScript(src){
        return new Promise((resolve, reject) => {
          try {
            const s = document.createElement('script');
            s.src = src;
            s.defer = true;
            s.setAttribute('data-mobile-loader', '1');
            s.onload = () => resolve();
            s.onerror = (e) => reject(e);
            document.body.appendChild(s);
          } catch (e) { reject(e); }
        });
      }

      // Load mobile adapter(s) after a short delay to let map.js initialize
      // We load map.mobile.js (adapter) first, then mobile.js (UI tweaks). Both are optional.
      setTimeout(() => {
        loadScript('js/map.mobile.js')
          .catch(err => { console.warn('Failed to load map.mobile.js', err); })
          .finally(() => {
            loadScript('js/mobile.js')
              .catch(err => { console.warn('Failed to load mobile.js', err); });
          });
      }, 120);
    })();
  </script>

  <!-- Try refresh modern controls after data loads. Keep this so UI syncs with mapData. -->
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      function tryRefresh(){
        if (window.ModernControls && typeof ModernControls.refresh === 'function' && typeof mapData !== 'undefined') {
          ModernControls.refresh();
        } else {
          setTimeout(tryRefresh, 300);
        }
      }
      tryRefresh();
    });
  </script>
</body>
</html>